function [T,Es_V,Es_iNa_m,Es_iNa_h,Es_iNaP_m,Es_iNaP_h,Es_iHVA_u,Es_iHVA_w,Es_iDR_n,Es_iKS_a,Es_iKS_b,Es_iKCa_c,Es_CaDyn_cai,Es_KDyn_ko,Ed_V,Ed_iNa_m,Ed_iNa_h,Ed_iNaP_m,Ed_iNaP_h,Ed_iHVA_u,Ed_iHVA_w,Ed_iDR_n,Ed_iKS_a,Ed_iKS_b,Ed_iKCa_c,Ed_CaDyn_cai,Ed_KDyn_ko,FS_V,FS_iNa_m,FS_iNa_h,FS_iDR_n,FS_KDyn_ko,Ed_Es_iAMPA_s,Ed_Es_iNMDA_s,FS_Es_iAMPA_s,FS_Es_iNMDA_s,Es_FS_iGABA_s,FS_FS_iGABA_s,Es_input,Ed_input,FS_input,Ed_Es_iAMPA_IAMPA,Ed_Es_iNMDA_BMg,Ed_Es_iNMDA_INMDA,Ed_Es_iNMDA_NT,Es_FS_iGABA_IGABA,FS_Es_iAMPA_IAMPA,FS_Es_iNMDA_BMg,FS_Es_iNMDA_INMDA,FS_Es_iNMDA_NT,FS_FS_iGABA_IGABA,Es_sAMPA,Es_sNMDA,Es_sGABA,Es_iHVA_wtauHVA,Ed_sAMPA,Ed_sNMDA,Ed_sGABA,Ed_iHVA_wtauHVA,FS_sAMPA,FS_sNMDA,FS_sGABA,Ed_Es_iAMPA_netcon,Ed_Es_iNMDA_netcon,FS_Es_iAMPA_netcon,FS_Es_iNMDA_netcon,Es_FS_iGABA_netcon,FS_FS_iGABA_netcon]=solve_ode
% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
p=load('params.mat','p'); p=p.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);
% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
Es_sAMPA = getPoissonGating(0,p.Es_dcAMPA,0,0,0,p.Es_onset,p.Es_offset,p.Es_tauAMPA,T,p.Es_Npop);
Es_sNMDA = getPoissonGating(0,p.Es_dcNMDA,0,0,0,p.Es_onset,p.Es_offset,p.Es_tauNMDA,T,p.Es_Npop);
Es_sGABA = getPoissonGating(0,p.Es_dcGABA,0,0,0,p.Es_onset,p.Es_offset,p.Es_tauGABA,T,p.Es_Npop);
Es_iHVA_wtauHVA = 420/3;
Ed_sAMPA = getPoissonGating(0,p.Ed_dcAMPA,0,0,0,p.Ed_onset,p.Ed_offset,p.Ed_tauAMPA,T,p.Ed_Npop);
Ed_sNMDA = getPoissonGating(0,p.Ed_dcNMDA,0,0,0,p.Ed_onset,p.Ed_offset,p.Ed_tauNMDA,T,p.Ed_Npop);
Ed_sGABA = getPoissonGating(0,p.Ed_dcGABA,0,0,0,p.Ed_onset,p.Ed_offset,p.Ed_tauGABA,T,p.Ed_Npop);
Ed_iHVA_wtauHVA = 420/3;
FS_sAMPA = getPoissonGating(0,p.FS_dcAMPA,0,0,0,p.FS_onset,p.FS_offset,p.FS_tauAMPA,T,p.FS_Npop);
FS_sNMDA = getPoissonGating(0,p.FS_dcNMDA,0,0,0,p.FS_onset,p.FS_offset,p.FS_tauNMDA,T,p.FS_Npop);
FS_sGABA = getPoissonGating(0,p.FS_dcGABA,0,0,0,p.FS_onset,p.FS_offset,p.FS_tauGABA,T,p.FS_Npop);
Ed_Es_iAMPA_netcon =  ones(p.Es_Npop,p.Ed_Npop);
Ed_Es_iNMDA_netcon =  ones(p.Es_Npop,p.Ed_Npop);
FS_Es_iAMPA_netcon =  ones(p.Es_Npop,p.FS_Npop);
FS_Es_iNMDA_netcon =  ones(p.Es_Npop,p.FS_Npop);
Es_FS_iGABA_netcon =  ones(p.FS_Npop,p.Es_Npop);
FS_FS_iGABA_netcon =  ones(p.FS_Npop,p.FS_Npop);
% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
% seed the random number generator
rng(p.random_seed);
t=0; k=1;
% STATE_VARIABLES:
Es_V = zeros(nsamp,p.Es_Npop);
  Es_V(1,:) = -65*ones(1,p.Es_Npop);
Es_iNa_m = zeros(nsamp,p.Es_Npop);
  Es_iNa_m(1,:) = (((((-.2816*(( ((abs(-65-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_amV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_amV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(-65-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_amV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_amV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(-65-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_bmV0))))./(-1+exp((( ((abs(-65-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(-65-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*-65-p.Es_iNa_bmV0)))/6)))))))+p.Es_iNa_IC_noise.*rand(1,p.Es_Npop);
Es_iNa_h = zeros(nsamp,p.Es_Npop);
  Es_iNa_h(1,:) = ((((p.Es_iNa_hnascale.*.098./exp((-65-p.Es_iNa_ahV0)/20)))./(((p.Es_iNa_hnascale.*.098./exp((-65-p.Es_iNa_ahV0)/20)))+((p.Es_iNa_hnascale.*1.4./(1+exp(-(-65-p.Es_iNa_bhV0)/10)))))))+p.Es_iNa_IC_noise.*rand(1,p.Es_Npop);
Es_iNaP_m = zeros(nsamp,p.Es_Npop);
  Es_iNaP_m(1,:) = (((((-.2816*(( ((abs(-65+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65+12)>=p.Es_iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65+12)>=p.Es_iNaP_eps).*-65+12)))/9.3))))./((((-.2816*(( ((abs(-65+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65+12)>=p.Es_iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65+12)>=p.Es_iNaP_eps).*-65+12)))/9.3))))+(((.2464*(( ((abs(-65-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65-15)>=p.Es_iNaP_eps).*-65-15))))./(-1+exp((( ((abs(-65-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(-65-15)>=p.Es_iNaP_eps).*-65-15)))/6)))))))+p.Es_iNaP_IC_noise.*rand(1,p.Es_Npop);
Es_iNaP_h = zeros(nsamp,p.Es_Npop);
  Es_iNaP_h(1,:) = ((((2.8e-5./exp((-65+42.8477)/4.0248)))./(((2.8e-5./exp((-65+42.8477)/4.0248)))+((.02./(1+exp(-(-65-413.9284)/148.2589)))))))+p.Es_iNaP_IC_noise.*rand(1,p.Es_Npop);
Es_iHVA_u = zeros(nsamp,p.Es_Npop);
  Es_iHVA_u(1,:) = ((1./(1+exp(-(-65+24.6)/11.3))))+p.Es_iHVA_IC_noise.*rand(1,p.Es_Npop);
Es_iHVA_w = zeros(nsamp,p.Es_Npop);
  Es_iHVA_w(1,:) = ((1./(1+exp((-65+12.6)/18.9))))+p.Es_iHVA_IC_noise.*rand(1,p.Es_Npop);
Es_iDR_n = zeros(nsamp,p.Es_Npop);
  Es_iDR_n(1,:) = ((((-.018*(( ((abs(-65-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_anV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_anV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_anV0)))/25))))./(((-.018*(( ((abs(-65-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_anV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_anV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_anV0)))/25))))+((.0054*(( ((abs(-65-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_bnV0)))./(-1+exp((( ((abs(-65-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(-65-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*-65-p.Es_iDR_bnV0)))/12)))))))+p.Es_iDR_IC_noise.*rand(1,p.Es_Npop);
Es_iKS_a = zeros(nsamp,p.Es_Npop);
  Es_iKS_a(1,:) = ((1./(1+exp(-(-65+34)/6.5))))+p.Es_iKS_IC_noise.*rand(1,p.Es_Npop);
Es_iKS_b = zeros(nsamp,p.Es_Npop);
  Es_iKS_b(1,:) = ((1./(1+exp((-65+65)/6.6))))+p.Es_iKS_IC_noise.*rand(1,p.Es_Npop);
Es_iKCa_c = zeros(nsamp,p.Es_Npop);
  Es_iKCa_c(1,:) = (((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))./((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))+((1.7*exp((((-65+40*log10(.05)))+152)./(-30.0)))))))+p.Es_iKCa_IC_noise.*rand(1,p.Es_Npop);
Es_CaDyn_cai = zeros(nsamp,p.Es_Npop);
  Es_CaDyn_cai(1,:) =  p.Es_CaDyn_cainf+p.Es_CaDyn_IC_noise.*rand(1,p.Es_Npop);
Es_KDyn_ko = zeros(nsamp,p.Es_Npop);
  Es_KDyn_ko(1,:) =  p.Es_KDyn_koinf+p.Es_KDyn_IC_noise.*rand(1,p.Es_Npop);
Ed_V = zeros(nsamp,p.Ed_Npop);
  Ed_V(1,:) = -65*ones(1,p.Ed_Npop);
Ed_iNa_m = zeros(nsamp,p.Ed_Npop);
  Ed_iNa_m(1,:) = (((((-.2816*(( ((abs(-65-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(-65-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(-65-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_bmV0))))./(-1+exp((( ((abs(-65-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(-65-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*-65-p.Ed_iNa_bmV0)))/6)))))))+p.Ed_iNa_IC_noise.*rand(1,p.Ed_Npop);
Ed_iNa_h = zeros(nsamp,p.Ed_Npop);
  Ed_iNa_h(1,:) = ((((p.Ed_iNa_hnascale.*.098./exp((-65-p.Ed_iNa_ahV0)/20)))./(((p.Ed_iNa_hnascale.*.098./exp((-65-p.Ed_iNa_ahV0)/20)))+((p.Ed_iNa_hnascale.*1.4./(1+exp(-(-65-p.Ed_iNa_bhV0)/10)))))))+p.Ed_iNa_IC_noise.*rand(1,p.Ed_Npop);
Ed_iNaP_m = zeros(nsamp,p.Ed_Npop);
  Ed_iNaP_m(1,:) = (((((-.2816*(( ((abs(-65+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65+12)>=p.Ed_iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65+12)>=p.Ed_iNaP_eps).*-65+12)))/9.3))))./((((-.2816*(( ((abs(-65+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65+12)>=p.Ed_iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65+12)>=p.Ed_iNaP_eps).*-65+12)))/9.3))))+(((.2464*(( ((abs(-65-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65-15)>=p.Ed_iNaP_eps).*-65-15))))./(-1+exp((( ((abs(-65-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(-65-15)>=p.Ed_iNaP_eps).*-65-15)))/6)))))))+p.Ed_iNaP_IC_noise.*rand(1,p.Ed_Npop);
Ed_iNaP_h = zeros(nsamp,p.Ed_Npop);
  Ed_iNaP_h(1,:) = ((((2.8e-5./exp((-65+42.8477)/4.0248)))./(((2.8e-5./exp((-65+42.8477)/4.0248)))+((.02./(1+exp(-(-65-413.9284)/148.2589)))))))+p.Ed_iNaP_IC_noise.*rand(1,p.Ed_Npop);
Ed_iHVA_u = zeros(nsamp,p.Ed_Npop);
  Ed_iHVA_u(1,:) = ((1./(1+exp(-(-65+24.6)/11.3))))+p.Ed_iHVA_IC_noise.*rand(1,p.Ed_Npop);
Ed_iHVA_w = zeros(nsamp,p.Ed_Npop);
  Ed_iHVA_w(1,:) = ((1./(1+exp((-65+12.6)/18.9))))+p.Ed_iHVA_IC_noise.*rand(1,p.Ed_Npop);
Ed_iDR_n = zeros(nsamp,p.Ed_Npop);
  Ed_iDR_n(1,:) = ((((-.018*(( ((abs(-65-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_anV0)))/25))))./(((-.018*(( ((abs(-65-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_anV0)))/25))))+((.0054*(( ((abs(-65-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_bnV0)))./(-1+exp((( ((abs(-65-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(-65-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*-65-p.Ed_iDR_bnV0)))/12)))))))+p.Ed_iDR_IC_noise.*rand(1,p.Ed_Npop);
Ed_iKS_a = zeros(nsamp,p.Ed_Npop);
  Ed_iKS_a(1,:) = ((1./(1+exp(-(-65+34)/6.5))))+p.Ed_iKS_IC_noise.*rand(1,p.Ed_Npop);
Ed_iKS_b = zeros(nsamp,p.Ed_Npop);
  Ed_iKS_b(1,:) = ((1./(1+exp((-65+65)/6.6))))+p.Ed_iKS_IC_noise.*rand(1,p.Ed_Npop);
Ed_iKCa_c = zeros(nsamp,p.Ed_Npop);
  Ed_iKCa_c(1,:) = (((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))./((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))+((1.7*exp((((-65+40*log10(.05)))+152)./(-30.0)))))))+p.Ed_iKCa_IC_noise.*rand(1,p.Ed_Npop);
Ed_CaDyn_cai = zeros(nsamp,p.Ed_Npop);
  Ed_CaDyn_cai(1,:) =  p.Ed_CaDyn_cainf+p.Ed_CaDyn_IC_noise.*rand(1,p.Ed_Npop);
Ed_KDyn_ko = zeros(nsamp,p.Ed_Npop);
  Ed_KDyn_ko(1,:) =  p.Ed_KDyn_koinf+p.Ed_KDyn_IC_noise.*rand(1,p.Ed_Npop);
FS_V = zeros(nsamp,p.FS_Npop);
  FS_V(1,:) = -65*ones(1,p.FS_Npop);
FS_iNa_m = zeros(nsamp,p.FS_Npop);
  FS_iNa_m(1,:) = (((((-.2816*(( ((abs(-65-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_amV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_amV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(-65-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_amV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_amV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(-65-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_bmV0))))./(-1+exp((( ((abs(-65-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(-65-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*-65-p.FS_iNa_bmV0)))/6)))))))+p.FS_iNa_IC_noise.*rand(1,p.FS_Npop);
FS_iNa_h = zeros(nsamp,p.FS_Npop);
  FS_iNa_h(1,:) = ((((p.FS_iNa_hnascale.*.098./exp((-65-p.FS_iNa_ahV0)/20)))./(((p.FS_iNa_hnascale.*.098./exp((-65-p.FS_iNa_ahV0)/20)))+((p.FS_iNa_hnascale.*1.4./(1+exp(-(-65-p.FS_iNa_bhV0)/10)))))))+p.FS_iNa_IC_noise.*rand(1,p.FS_Npop);
FS_iDR_n = zeros(nsamp,p.FS_Npop);
  FS_iDR_n(1,:) = ((((-.018*(( ((abs(-65-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_anV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_anV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_anV0)))/25))))./(((-.018*(( ((abs(-65-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_anV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_anV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_anV0)))/25))))+((.0054*(( ((abs(-65-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_bnV0)))./(-1+exp((( ((abs(-65-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(-65-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*-65-p.FS_iDR_bnV0)))/12)))))))+p.FS_iDR_IC_noise.*rand(1,p.FS_Npop);
FS_KDyn_ko = zeros(nsamp,p.FS_Npop);
  FS_KDyn_ko(1,:) =  p.FS_KDyn_koinf+p.FS_KDyn_IC_noise.*rand(1,p.FS_Npop);
Ed_Es_iAMPA_s = zeros(nsamp,p.Es_Npop);
  Ed_Es_iAMPA_s(1,:) =  p.Ed_Es_iAMPA_IC+p.Ed_Es_iAMPA_IC_noise.*rand(1,p.Es_Npop);
Ed_Es_iNMDA_s = zeros(nsamp,p.Es_Npop);
  Ed_Es_iNMDA_s(1,:) =  p.Ed_Es_iNMDA_IC+p.Ed_Es_iNMDA_IC_noise*rand(1,p.Es_Npop);
FS_Es_iAMPA_s = zeros(nsamp,p.Es_Npop);
  FS_Es_iAMPA_s(1,:) =  p.FS_Es_iAMPA_IC+p.FS_Es_iAMPA_IC_noise.*rand(1,p.Es_Npop);
FS_Es_iNMDA_s = zeros(nsamp,p.Es_Npop);
  FS_Es_iNMDA_s(1,:) =  p.FS_Es_iNMDA_IC+p.FS_Es_iNMDA_IC_noise*rand(1,p.Es_Npop);
Es_FS_iGABA_s = zeros(nsamp,p.FS_Npop);
  Es_FS_iGABA_s(1,:) =  p.Es_FS_iGABA_IC+p.Es_FS_iGABA_IC_noise.*rand(1,p.FS_Npop);
FS_FS_iGABA_s = zeros(nsamp,p.FS_Npop);
  FS_FS_iGABA_s(1,:) =  p.FS_FS_iGABA_IC+p.FS_FS_iGABA_IC_noise.*rand(1,p.FS_Npop);
% MONITORS:
Es_input = zeros(nsamp,p.Es_Npop);
  Es_input(1,:)=((-p.Es_gAMPA.*Es_sAMPA(k,:).*(Es_V(1,:)-p.Es_EAMPA)))+((-p.Es_gNMDA.*Es_sNMDA(k,:).*(1.50265./(1+0.33*exp(Es_V(1,:)./(-16)))).*(Es_V(1,:)-p.Es_ENMDA)))+((-p.Es_gGABA.*Es_sGABA(k,:).*(Es_V(1,:)-p.Es_EGABA)));
Ed_input = zeros(nsamp,p.Ed_Npop);
  Ed_input(1,:)=((-p.Ed_gAMPA.*Ed_sAMPA(k,:).*(Ed_V(1,:)-p.Ed_EAMPA)))+((-p.Ed_gNMDA.*Ed_sNMDA(k,:).*(1.50265./(1+0.33*exp(Ed_V(1,:)./(-16)))).*(Ed_V(1,:)-p.Ed_ENMDA)))+((-p.Ed_gGABA.*Ed_sGABA(k,:).*(Ed_V(1,:)-p.Ed_EGABA)));
FS_input = zeros(nsamp,p.FS_Npop);
  FS_input(1,:)=((-p.FS_gAMPA.*FS_sAMPA(k,:).*(FS_V(1,:)-p.FS_EAMPA)))+((-p.FS_gNMDA.*FS_sNMDA(k,:).*(1.50265./(1+0.33*exp(FS_V(1,:)./(-16)))).*(FS_V(1,:)-p.FS_ENMDA)))+((-p.FS_gGABA.*FS_sGABA(k,:).*(FS_V(1,:)-p.FS_EGABA)));
Ed_Es_iAMPA_IAMPA = zeros(nsamp,p.Ed_Npop);
  Ed_Es_iAMPA_IAMPA(1,:)=(p.Ed_Es_iAMPA_gAMPA.*(Ed_Es_iAMPA_s(1,:)*Ed_Es_iAMPA_netcon).*(Ed_V(1,:)-p.Ed_Es_iAMPA_EAMPA));
Ed_Es_iNMDA_BMg = zeros(nsamp,p.Ed_Npop);
  Ed_Es_iNMDA_BMg(1,:)=(1.50265./(1+0.33*exp(Ed_V(1,:)./(-16))));
Ed_Es_iNMDA_INMDA = zeros(nsamp,p.Ed_Npop);
  Ed_Es_iNMDA_INMDA(1,:)=p.Ed_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(Ed_V(1,:)./(-16)))))).*(Ed_Es_iNMDA_s(1,:)*Ed_Es_iNMDA_netcon).*(Ed_V(1,:)-p.Ed_Es_iNMDA_ENMDA);
Ed_Es_iNMDA_NT = zeros(nsamp,p.Ed_Npop);
  Ed_Es_iNMDA_NT(1,:)=p.Ed_Es_iNMDA_Tmax./(1+exp(-(Ed_V(1,:)-p.Ed_Es_iNMDA_Vpp)/p.Ed_Es_iNMDA_Kp));
Es_FS_iGABA_IGABA = zeros(nsamp,p.Es_Npop);
  Es_FS_iGABA_IGABA(1,:)=(p.Es_FS_iGABA_gGABA.*(Es_FS_iGABA_s(1,:)*Es_FS_iGABA_netcon).*(Es_V(1,:)-p.Es_FS_iGABA_EGABA));
FS_Es_iAMPA_IAMPA = zeros(nsamp,p.FS_Npop);
  FS_Es_iAMPA_IAMPA(1,:)=(p.FS_Es_iAMPA_gAMPA.*(FS_Es_iAMPA_s(1,:)*FS_Es_iAMPA_netcon).*(FS_V(1,:)-p.FS_Es_iAMPA_EAMPA));
FS_Es_iNMDA_BMg = zeros(nsamp,p.FS_Npop);
  FS_Es_iNMDA_BMg(1,:)=(1.50265./(1+0.33*exp(FS_V(1,:)./(-16))));
FS_Es_iNMDA_INMDA = zeros(nsamp,p.FS_Npop);
  FS_Es_iNMDA_INMDA(1,:)=p.FS_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(FS_V(1,:)./(-16)))))).*(FS_Es_iNMDA_s(1,:)*FS_Es_iNMDA_netcon).*(FS_V(1,:)-p.FS_Es_iNMDA_ENMDA);
FS_Es_iNMDA_NT = zeros(nsamp,p.FS_Npop);
  FS_Es_iNMDA_NT(1,:)=p.FS_Es_iNMDA_Tmax./(1+exp(-(FS_V(1,:)-p.FS_Es_iNMDA_Vpp)/p.FS_Es_iNMDA_Kp));
FS_FS_iGABA_IGABA = zeros(nsamp,p.FS_Npop);
  FS_FS_iGABA_IGABA(1,:)=(p.FS_FS_iGABA_gGABA.*(FS_FS_iGABA_s(1,:)*FS_FS_iGABA_netcon).*(FS_V(1,:)-p.FS_FS_iGABA_EGABA));
% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  Es_V_k1=(((-((p.Es_iNa_gnaf.*Es_iNa_m(n-1,:).^3.*Es_iNa_h(n-1,:).*(Es_V(n-1,:)-p.Es_iNa_ENa))))+((-((p.Es_iNaP_gnap.*Es_iNaP_m(n-1,:).*Es_iNaP_h(n-1,:).*(Es_V(n-1,:)-p.Es_iNaP_ENa))))+((-((p.Es_iHVA_ghva.*Es_iHVA_u(n-1,:).^2.*Es_iHVA_w(n-1,:).*(Es_V(n-1,:)-((min(500,12.5*log(p.Es_iHVA_cao./Es_CaDyn_cai(n-1,:)))))))))+((-((p.Es_iDR_gkdr.*Es_iDR_n(n-1,:).^4.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iDR_ki)))))))+((-(( p.Es_iKS_gks.*Es_iKS_a(n-1,:).*Es_iKS_b(n-1,:).*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKS_ki)))))))+((-((p.Es_iKCa_gkc.*Es_iKCa_c(n-1,:).^2.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKCa_ki)))))))+((-((p.Es_pas_gpas.*(Es_V(n-1,:)-p.Es_pas_epas))))+(((( p.Es_Ed_iCOM_gCOM.*(Ed_V(n-1,:)-Es_V(n-1,:)))))+((-(( (p.Es_FS_iGABA_gGABA.*(Es_FS_iGABA_s(n-1)*Es_FS_iGABA_netcon).*(Es_V(n-1,:)-p.Es_FS_iGABA_EGABA))))))))))))))+((((-p.Es_gAMPA.*Es_sAMPA(k,:).*(Es_V(n-1,:)-p.Es_EAMPA)))+((-p.Es_gNMDA.*Es_sNMDA(k,:).*(1.50265./(1+0.33*exp(Es_V(n-1,:)./(-16)))).*(Es_V(n-1,:)-p.Es_ENMDA)))+((-p.Es_gGABA.*Es_sGABA(k,:).*(Es_V(n-1,:)-p.Es_EGABA))))))./p.Es_Cm;
  Es_iNa_m_k1=((((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0)))/6)))))))-Es_iNa_m(n-1,:))./((1./((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0)))/6)))))));
  Es_iNa_h_k1=(((((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))./(((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))+((p.Es_iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1,:)-p.Es_iNa_bhV0)/10)))))))-Es_iNa_h(n-1,:))./((1./(((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))+((p.Es_iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1,:)-p.Es_iNa_bhV0)/10)))))));
  Es_iNaP_m_k1=((((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15))))./(-1+exp((( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15)))/6)))))))-Es_iNaP_m(n-1,:))./((1./((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15))))./(-1+exp((( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15)))/6)))))));
  Es_iNaP_h_k1=(((((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))./(((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1,:)-413.9284)/148.2589)))))))-Es_iNaP_h(n-1,:))./((p.Es_iNaP_htaunap*1./(((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1,:)-413.9284)/148.2589)))))));
  Es_iHVA_u_k1=(((1./(1+exp(-(Es_V(n-1,:)+24.6)/11.3))))-Es_iHVA_u(n-1,:))./((1.25*sech(-.031*(Es_V(n-1,:)+37.1))));
  Es_iHVA_w_k1=(((1./(1+exp((Es_V(n-1,:)+12.6)/18.9))))-Es_iHVA_w(n-1,:))./((Es_iHVA_wtauHVA));
  Es_iDR_n_k1=(((((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))./(((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))/12)))))))-Es_iDR_n(n-1,:))./((1./(((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))/12)))))));
  Es_iKS_a_k1=(((1./(1+exp(-(Es_V(n-1,:)+34)/6.5))))-Es_iKS_a(n-1,:))./((6));
  Es_iKS_b_k1=(((1./(1+exp((Es_V(n-1,:)+65)/6.6))))-Es_iKS_b(n-1,:))./((200+220./(1+exp(-(Es_V(n-1,:)+71.6)/6.85))));
  Es_iKCa_c_k1=((((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+152)./(-30.0)))))))-Es_iKCa_c(n-1,:))./((1./((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+152)./(-30.0)))))));
  Es_CaDyn_cai_k1= -p.Es_CaDyn_CAF.*((((p.Es_iHVA_ghva.*Es_iHVA_u(n-1,:).^2.*Es_iHVA_w(n-1,:).*(Es_V(n-1,:)-((min(500,12.5*log(p.Es_iHVA_cao./Es_CaDyn_cai(n-1,:))))))))))./(p.Es_CaDyn_faraday*p.Es_CaDyn_VshellCa)+(p.Es_CaDyn_cainf-Es_CaDyn_cai(n-1,:))./p.Es_CaDyn_tauCa;
  Es_KDyn_ko_k1= p.Es_KDyn_KAF.*((((p.Es_iDR_gkdr.*Es_iDR_n(n-1,:).^4.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iDR_ki)))))))+(((( p.Es_iKS_gks.*Es_iKS_a(n-1,:).*Es_iKS_b(n-1,:).*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKS_ki)))))))+((((p.Es_iKCa_gkc.*Es_iKCa_c(n-1,:).^2.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKCa_ki))))))))))./(p.Es_KDyn_faraday*p.Es_KDyn_VshellK)+(p.Es_KDyn_koinf-Es_KDyn_ko(n-1,:))./p.Es_KDyn_tauK;
  Ed_V_k1=(((-((p.Ed_iNa_gnaf.*Ed_iNa_m(n-1,:).^3.*Ed_iNa_h(n-1,:).*(Ed_V(n-1,:)-p.Ed_iNa_ENa))))+((-((p.Ed_iNaP_gnap.*Ed_iNaP_m(n-1,:).*Ed_iNaP_h(n-1,:).*(Ed_V(n-1,:)-p.Ed_iNaP_ENa))))+((-((p.Ed_iHVA_ghva.*Ed_iHVA_u(n-1,:).^2.*Ed_iHVA_w(n-1,:).*(Ed_V(n-1,:)-((min(500,12.5*log(p.Ed_iHVA_cao./Ed_CaDyn_cai(n-1,:)))))))))+((-((p.Ed_iDR_gkdr.*Ed_iDR_n(n-1,:).^4.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iDR_ki)))))))+((-(( p.Ed_iKS_gks.*Ed_iKS_a(n-1,:).*Ed_iKS_b(n-1,:).*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKS_ki)))))))+((-((p.Ed_iKCa_gkc.*Ed_iKCa_c(n-1,:).^2.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKCa_ki)))))))+((-((p.Ed_pas_gpas.*(Ed_V(n-1,:)-p.Ed_pas_epas))))+((-(( (p.Ed_Es_iAMPA_gAMPA.*(Ed_Es_iAMPA_s(n-1,:)*Ed_Es_iAMPA_netcon).*(Ed_V(n-1,:)-p.Ed_Es_iAMPA_EAMPA)))))+((-(( p.Ed_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(Ed_V(n-1,:)./(-16)))))).*(Ed_Es_iNMDA_s(n-1,:)*Ed_Es_iNMDA_netcon).*(Ed_V(n-1,:)-p.Ed_Es_iNMDA_ENMDA))))+(((( p.Ed_Es_iCOM_gCOM.*(Es_V(n-1,:)-Ed_V(n-1,:)))))))))))))))+((((-p.Ed_gAMPA.*Ed_sAMPA(k,:).*(Ed_V(n-1,:)-p.Ed_EAMPA)))+((-p.Ed_gNMDA.*Ed_sNMDA(k,:).*(1.50265./(1+0.33*exp(Ed_V(n-1,:)./(-16)))).*(Ed_V(n-1,:)-p.Ed_ENMDA)))+((-p.Ed_gGABA.*Ed_sGABA(k,:).*(Ed_V(n-1,:)-p.Ed_EGABA))))))./p.Ed_Cm;
  Ed_iNa_m_k1=((((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0)))/6)))))))-Ed_iNa_m(n-1,:))./((1./((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0)))/6)))))));
  Ed_iNa_h_k1=(((((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))./(((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))+((p.Ed_iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1,:)-p.Ed_iNa_bhV0)/10)))))))-Ed_iNa_h(n-1,:))./((1./(((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))+((p.Ed_iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1,:)-p.Ed_iNa_bhV0)/10)))))));
  Ed_iNaP_m_k1=((((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15))))./(-1+exp((( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15)))/6)))))))-Ed_iNaP_m(n-1,:))./((1./((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15))))./(-1+exp((( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15)))/6)))))));
  Ed_iNaP_h_k1=(((((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))./(((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1,:)-413.9284)/148.2589)))))))-Ed_iNaP_h(n-1,:))./((p.Ed_iNaP_htaunap*1./(((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1,:)-413.9284)/148.2589)))))));
  Ed_iHVA_u_k1=(((1./(1+exp(-(Ed_V(n-1,:)+24.6)/11.3))))-Ed_iHVA_u(n-1,:))./((1.25*sech(-.031*(Ed_V(n-1,:)+37.1))));
  Ed_iHVA_w_k1=(((1./(1+exp((Ed_V(n-1,:)+12.6)/18.9))))-Ed_iHVA_w(n-1,:))./((Ed_iHVA_wtauHVA));
  Ed_iDR_n_k1=(((((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))./(((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))/12)))))))-Ed_iDR_n(n-1,:))./((1./(((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))/12)))))));
  Ed_iKS_a_k1=(((1./(1+exp(-(Ed_V(n-1,:)+34)/6.5))))-Ed_iKS_a(n-1,:))./((6));
  Ed_iKS_b_k1=(((1./(1+exp((Ed_V(n-1,:)+65)/6.6))))-Ed_iKS_b(n-1,:))./((200+220./(1+exp(-(Ed_V(n-1,:)+71.6)/6.85))));
  Ed_iKCa_c_k1=((((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+152)./(-30.0)))))))-Ed_iKCa_c(n-1,:))./((1./((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+152)./(-30.0)))))));
  Ed_CaDyn_cai_k1= -p.Ed_CaDyn_CAF.*((((p.Ed_iHVA_ghva.*Ed_iHVA_u(n-1,:).^2.*Ed_iHVA_w(n-1,:).*(Ed_V(n-1,:)-((min(500,12.5*log(p.Ed_iHVA_cao./Ed_CaDyn_cai(n-1,:))))))))))./(p.Ed_CaDyn_faraday*p.Ed_CaDyn_VshellCa)+(p.Ed_CaDyn_cainf-Ed_CaDyn_cai(n-1,:))./p.Ed_CaDyn_tauCa;
  Ed_KDyn_ko_k1= p.Ed_KDyn_KAF.*((((p.Ed_iDR_gkdr.*Ed_iDR_n(n-1,:).^4.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iDR_ki)))))))+(((( p.Ed_iKS_gks.*Ed_iKS_a(n-1,:).*Ed_iKS_b(n-1,:).*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKS_ki)))))))+((((p.Ed_iKCa_gkc.*Ed_iKCa_c(n-1,:).^2.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKCa_ki))))))))))./(p.Ed_KDyn_faraday*p.Ed_KDyn_VshellK)+(p.Ed_KDyn_koinf-Ed_KDyn_ko(n-1,:))./p.Ed_KDyn_tauK;
  FS_V_k1=(((-((p.FS_iNa_gnaf.*FS_iNa_m(n-1).^3.*FS_iNa_h(n-1).*(FS_V(n-1)-p.FS_iNa_ENa))))+((-((p.FS_iDR_gkdr.*FS_iDR_n(n-1).^4.*(FS_V(n-1)-((25*log(FS_KDyn_ko(n-1)/p.FS_iDR_ki)))))))+((-((p.FS_pas_gpas.*(FS_V(n-1)-p.FS_pas_epas))))+((-(( (p.FS_Es_iAMPA_gAMPA.*(FS_Es_iAMPA_s(n-1,:)*FS_Es_iAMPA_netcon).*(FS_V(n-1)-p.FS_Es_iAMPA_EAMPA)))))+((-(( p.FS_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(FS_V(n-1)./(-16)))))).*(FS_Es_iNMDA_s(n-1,:)*FS_Es_iNMDA_netcon).*(FS_V(n-1)-p.FS_Es_iNMDA_ENMDA))))+((-(( (p.FS_FS_iGABA_gGABA.*(FS_FS_iGABA_s(n-1)*FS_FS_iGABA_netcon).*(FS_V(n-1)-p.FS_FS_iGABA_EGABA)))))))))))+((((-p.FS_gAMPA.*FS_sAMPA(k,:).*(FS_V(n-1)-p.FS_EAMPA)))+((-p.FS_gNMDA.*FS_sNMDA(k,:).*(1.50265./(1+0.33*exp(FS_V(n-1)./(-16)))).*(FS_V(n-1)-p.FS_ENMDA)))+((-p.FS_gGABA.*FS_sGABA(k,:).*(FS_V(n-1)-p.FS_EGABA))))))./p.FS_Cm;
  FS_iNa_m_k1=((((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0))))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0)))/6)))))))-FS_iNa_m(n-1))./((1./((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0))))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0)))/6)))))));
  FS_iNa_h_k1=(((((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))./(((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))+((p.FS_iNa_hnascale.*1.4./(1+exp(-(FS_V(n-1)-p.FS_iNa_bhV0)/10)))))))-FS_iNa_h(n-1))./((1./(((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))+((p.FS_iNa_hnascale.*1.4./(1+exp(-(FS_V(n-1)-p.FS_iNa_bhV0)/10)))))));
  FS_iDR_n_k1=(((((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))./(((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))+((.0054*(( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))/12)))))))-FS_iDR_n(n-1))./((1./(((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))+((.0054*(( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))/12)))))));
  FS_KDyn_ko_k1= p.FS_KDyn_KAF.*((((p.FS_iDR_gkdr.*FS_iDR_n(n-1).^4.*(FS_V(n-1)-((25*log(FS_KDyn_ko(n-1)/p.FS_iDR_ki))))))))./(p.FS_KDyn_faraday*p.FS_KDyn_VshellK)+(p.FS_KDyn_koinf-FS_KDyn_ko(n-1))./p.FS_KDyn_tauK;
  Ed_Es_iAMPA_s_k1= -Ed_Es_iAMPA_s(n-1,:)./p.Ed_Es_iAMPA_tauAMPA + ((1-Ed_Es_iAMPA_s(n-1,:))/p.Ed_Es_iAMPA_tauAMPAr).*(1+tanh(Es_V(n-1,:)/10));
  Ed_Es_iNMDA_s_k1= (( p.Ed_Es_iNMDA_Tmax./(1+exp(-(Es_V(n-1,:)-p.Ed_Es_iNMDA_Vpp)/p.Ed_Es_iNMDA_Kp)))).*(1-Ed_Es_iNMDA_s(n-1,:))/p.Ed_Es_iNMDA_tauNMDAr-Ed_Es_iNMDA_s(n-1,:)/p.Ed_Es_iNMDA_tauNMDA;
  FS_Es_iAMPA_s_k1= -FS_Es_iAMPA_s(n-1,:)./p.FS_Es_iAMPA_tauAMPA + ((1-FS_Es_iAMPA_s(n-1,:))/p.FS_Es_iAMPA_tauAMPAr).*(1+tanh(Es_V(n-1,:)/10));
  FS_Es_iNMDA_s_k1= (( p.FS_Es_iNMDA_Tmax./(1+exp(-(Es_V(n-1,:)-p.FS_Es_iNMDA_Vpp)/p.FS_Es_iNMDA_Kp)))).*(1-FS_Es_iNMDA_s(n-1,:))/p.FS_Es_iNMDA_tauNMDAr-FS_Es_iNMDA_s(n-1,:)/p.FS_Es_iNMDA_tauNMDA;
  Es_FS_iGABA_s_k1= -Es_FS_iGABA_s(n-1)./p.Es_FS_iGABA_tauGABA + ((1-Es_FS_iGABA_s(n-1))/p.Es_FS_iGABA_tauGABAr).*(1+tanh(FS_V(n-1)/10));
  FS_FS_iGABA_s_k1= -FS_FS_iGABA_s(n-1)./p.FS_FS_iGABA_tauGABA + ((1-FS_FS_iGABA_s(n-1))/p.FS_FS_iGABA_tauGABAr).*(1+tanh(FS_V(n-1)/10));
  t=t+.5*dt;
  Es_V_k2=(((-((p.Es_iNa_gnaf.*Es_iNa_m(n-1,:).^3.*Es_iNa_h(n-1,:).*(Es_V(n-1,:)-p.Es_iNa_ENa))))+((-((p.Es_iNaP_gnap.*Es_iNaP_m(n-1,:).*Es_iNaP_h(n-1,:).*(Es_V(n-1,:)-p.Es_iNaP_ENa))))+((-((p.Es_iHVA_ghva.*Es_iHVA_u(n-1,:).^2.*Es_iHVA_w(n-1,:).*(Es_V(n-1,:)-((min(500,12.5*log(p.Es_iHVA_cao./Es_CaDyn_cai(n-1,:)))))))))+((-((p.Es_iDR_gkdr.*Es_iDR_n(n-1,:).^4.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iDR_ki)))))))+((-(( p.Es_iKS_gks.*Es_iKS_a(n-1,:).*Es_iKS_b(n-1,:).*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKS_ki)))))))+((-((p.Es_iKCa_gkc.*Es_iKCa_c(n-1,:).^2.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKCa_ki)))))))+((-((p.Es_pas_gpas.*(Es_V(n-1,:)-p.Es_pas_epas))))+(((( p.Es_Ed_iCOM_gCOM.*(Ed_V(n-1,:)-Es_V(n-1,:)))))+((-(( (p.Es_FS_iGABA_gGABA.*(Es_FS_iGABA_s(n-1)*Es_FS_iGABA_netcon).*(Es_V(n-1,:)-p.Es_FS_iGABA_EGABA))))))))))))))+((((-p.Es_gAMPA.*Es_sAMPA(k,:).*(Es_V(n-1,:)-p.Es_EAMPA)))+((-p.Es_gNMDA.*Es_sNMDA(k,:).*(1.50265./(1+0.33*exp(Es_V(n-1,:)./(-16)))).*(Es_V(n-1,:)-p.Es_ENMDA)))+((-p.Es_gGABA.*Es_sGABA(k,:).*(Es_V(n-1,:)-p.Es_EGABA))))))./p.Es_Cm;
  Es_iNa_m_k2=((((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0)))/6)))))))-Es_iNa_m(n-1,:))./((1./((((-.2816*(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iNa_amV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_amV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iNa_bmV0)<p.Es_iNa_eps).*p.Es_iNa_eps+(abs(Es_V(n-1,:)-p.Es_iNa_bmV0)>=p.Es_iNa_eps).*Es_V(n-1,:)-p.Es_iNa_bmV0)))/6)))))));
  Es_iNa_h_k2=(((((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))./(((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))+((p.Es_iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1,:)-p.Es_iNa_bhV0)/10)))))))-Es_iNa_h(n-1,:))./((1./(((p.Es_iNa_hnascale.*.098./exp((Es_V(n-1,:)-p.Es_iNa_ahV0)/20)))+((p.Es_iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1,:)-p.Es_iNa_bhV0)/10)))))));
  Es_iNaP_m_k2=((((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15))))./(-1+exp((( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15)))/6)))))))-Es_iNaP_m(n-1,:))./((1./((((-.2816*(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Es_V(n-1,:)+12)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)+12)>=p.Es_iNaP_eps).*Es_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15))))./(-1+exp((( ((abs(Es_V(n-1,:)-15)<p.Es_iNaP_eps).*p.Es_iNaP_eps+(abs(Es_V(n-1,:)-15)>=p.Es_iNaP_eps).*Es_V(n-1,:)-15)))/6)))))));
  Es_iNaP_h_k2=(((((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))./(((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1,:)-413.9284)/148.2589)))))))-Es_iNaP_h(n-1,:))./((p.Es_iNaP_htaunap*1./(((2.8e-5./exp((Es_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1,:)-413.9284)/148.2589)))))));
  Es_iHVA_u_k2=(((1./(1+exp(-(Es_V(n-1,:)+24.6)/11.3))))-Es_iHVA_u(n-1,:))./((1.25*sech(-.031*(Es_V(n-1,:)+37.1))));
  Es_iHVA_w_k2=(((1./(1+exp((Es_V(n-1,:)+12.6)/18.9))))-Es_iHVA_w(n-1,:))./((Es_iHVA_wtauHVA));
  Es_iDR_n_k2=(((((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))./(((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))/12)))))))-Es_iDR_n(n-1,:))./((1./(((-.018*(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1,:)-p.Es_iDR_anV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_anV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1,:)-p.Es_iDR_bnV0)<p.Es_iDR_eps).*p.Es_iDR_eps+(abs(Es_V(n-1,:)-p.Es_iDR_bnV0)>=p.Es_iDR_eps).*Es_V(n-1,:)-p.Es_iDR_bnV0)))/12)))))));
  Es_iKS_a_k2=(((1./(1+exp(-(Es_V(n-1,:)+34)/6.5))))-Es_iKS_a(n-1,:))./((6));
  Es_iKS_b_k2=(((1./(1+exp((Es_V(n-1,:)+65)/6.6))))-Es_iKS_b(n-1,:))./((200+220./(1+exp(-(Es_V(n-1,:)+71.6)/6.85))));
  Es_iKCa_c_k2=((((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+152)./(-30.0)))))))-Es_iKCa_c(n-1,:))./((1./((((-0.00642*(( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)<p.Es_iKCa_eps).*p.Es_iKCa_eps+(abs(((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)>=p.Es_iKCa_eps).*((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1,:)+40*log10(Es_CaDyn_cai(n-1,:))))+152)./(-30.0)))))));
  Es_CaDyn_cai_k2= -p.Es_CaDyn_CAF.*((((p.Es_iHVA_ghva.*Es_iHVA_u(n-1,:).^2.*Es_iHVA_w(n-1,:).*(Es_V(n-1,:)-((min(500,12.5*log(p.Es_iHVA_cao./Es_CaDyn_cai(n-1,:))))))))))./(p.Es_CaDyn_faraday*p.Es_CaDyn_VshellCa)+(p.Es_CaDyn_cainf-Es_CaDyn_cai(n-1,:))./p.Es_CaDyn_tauCa;
  Es_KDyn_ko_k2= p.Es_KDyn_KAF.*((((p.Es_iDR_gkdr.*Es_iDR_n(n-1,:).^4.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iDR_ki)))))))+(((( p.Es_iKS_gks.*Es_iKS_a(n-1,:).*Es_iKS_b(n-1,:).*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKS_ki)))))))+((((p.Es_iKCa_gkc.*Es_iKCa_c(n-1,:).^2.*(Es_V(n-1,:)-((25*log(Es_KDyn_ko(n-1,:)/p.Es_iKCa_ki))))))))))./(p.Es_KDyn_faraday*p.Es_KDyn_VshellK)+(p.Es_KDyn_koinf-Es_KDyn_ko(n-1,:))./p.Es_KDyn_tauK;
  Ed_V_k2=(((-((p.Ed_iNa_gnaf.*Ed_iNa_m(n-1,:).^3.*Ed_iNa_h(n-1,:).*(Ed_V(n-1,:)-p.Ed_iNa_ENa))))+((-((p.Ed_iNaP_gnap.*Ed_iNaP_m(n-1,:).*Ed_iNaP_h(n-1,:).*(Ed_V(n-1,:)-p.Ed_iNaP_ENa))))+((-((p.Ed_iHVA_ghva.*Ed_iHVA_u(n-1,:).^2.*Ed_iHVA_w(n-1,:).*(Ed_V(n-1,:)-((min(500,12.5*log(p.Ed_iHVA_cao./Ed_CaDyn_cai(n-1,:)))))))))+((-((p.Ed_iDR_gkdr.*Ed_iDR_n(n-1,:).^4.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iDR_ki)))))))+((-(( p.Ed_iKS_gks.*Ed_iKS_a(n-1,:).*Ed_iKS_b(n-1,:).*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKS_ki)))))))+((-((p.Ed_iKCa_gkc.*Ed_iKCa_c(n-1,:).^2.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKCa_ki)))))))+((-((p.Ed_pas_gpas.*(Ed_V(n-1,:)-p.Ed_pas_epas))))+((-(( (p.Ed_Es_iAMPA_gAMPA.*(Ed_Es_iAMPA_s(n-1,:)*Ed_Es_iAMPA_netcon).*(Ed_V(n-1,:)-p.Ed_Es_iAMPA_EAMPA)))))+((-(( p.Ed_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(Ed_V(n-1,:)./(-16)))))).*(Ed_Es_iNMDA_s(n-1,:)*Ed_Es_iNMDA_netcon).*(Ed_V(n-1,:)-p.Ed_Es_iNMDA_ENMDA))))+(((( p.Ed_Es_iCOM_gCOM.*(Es_V(n-1,:)-Ed_V(n-1,:)))))))))))))))+((((-p.Ed_gAMPA.*Ed_sAMPA(k,:).*(Ed_V(n-1,:)-p.Ed_EAMPA)))+((-p.Ed_gNMDA.*Ed_sNMDA(k,:).*(1.50265./(1+0.33*exp(Ed_V(n-1,:)./(-16)))).*(Ed_V(n-1,:)-p.Ed_ENMDA)))+((-p.Ed_gGABA.*Ed_sGABA(k,:).*(Ed_V(n-1,:)-p.Ed_EGABA))))))./p.Ed_Cm;
  Ed_iNa_m_k2=((((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0)))/6)))))))-Ed_iNa_m(n-1,:))./((1./((((-.2816*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_amV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)<p.Ed_iNa_eps).*p.Ed_iNa_eps+(abs(Ed_V(n-1,:)-p.Ed_iNa_bmV0)>=p.Ed_iNa_eps).*Ed_V(n-1,:)-p.Ed_iNa_bmV0)))/6)))))));
  Ed_iNa_h_k2=(((((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))./(((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))+((p.Ed_iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1,:)-p.Ed_iNa_bhV0)/10)))))))-Ed_iNa_h(n-1,:))./((1./(((p.Ed_iNa_hnascale.*.098./exp((Ed_V(n-1,:)-p.Ed_iNa_ahV0)/20)))+((p.Ed_iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1,:)-p.Ed_iNa_bhV0)/10)))))));
  Ed_iNaP_m_k2=((((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15))))./(-1+exp((( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15)))/6)))))))-Ed_iNaP_m(n-1,:))./((1./((((-.2816*(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1,:)+12)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)+12)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15))))./(-1+exp((( ((abs(Ed_V(n-1,:)-15)<p.Ed_iNaP_eps).*p.Ed_iNaP_eps+(abs(Ed_V(n-1,:)-15)>=p.Ed_iNaP_eps).*Ed_V(n-1,:)-15)))/6)))))));
  Ed_iNaP_h_k2=(((((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))./(((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1,:)-413.9284)/148.2589)))))))-Ed_iNaP_h(n-1,:))./((p.Ed_iNaP_htaunap*1./(((2.8e-5./exp((Ed_V(n-1,:)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1,:)-413.9284)/148.2589)))))));
  Ed_iHVA_u_k2=(((1./(1+exp(-(Ed_V(n-1,:)+24.6)/11.3))))-Ed_iHVA_u(n-1,:))./((1.25*sech(-.031*(Ed_V(n-1,:)+37.1))));
  Ed_iHVA_w_k2=(((1./(1+exp((Ed_V(n-1,:)+12.6)/18.9))))-Ed_iHVA_w(n-1,:))./((Ed_iHVA_wtauHVA));
  Ed_iDR_n_k2=(((((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))./(((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))/12)))))))-Ed_iDR_n(n-1,:))./((1./(((-.018*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_anV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)<p.Ed_iDR_eps).*p.Ed_iDR_eps+(abs(Ed_V(n-1,:)-p.Ed_iDR_bnV0)>=p.Ed_iDR_eps).*Ed_V(n-1,:)-p.Ed_iDR_bnV0)))/12)))))));
  Ed_iKS_a_k2=(((1./(1+exp(-(Ed_V(n-1,:)+34)/6.5))))-Ed_iKS_a(n-1,:))./((6));
  Ed_iKS_b_k2=(((1./(1+exp((Ed_V(n-1,:)+65)/6.6))))-Ed_iKS_b(n-1,:))./((200+220./(1+exp(-(Ed_V(n-1,:)+71.6)/6.85))));
  Ed_iKCa_c_k2=((((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+152)./(-30.0)))))))-Ed_iKCa_c(n-1,:))./((1./((((-0.00642*(( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)<p.Ed_iKCa_eps).*p.Ed_iKCa_eps+(abs(((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)>=p.Ed_iKCa_eps).*((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1,:)+40*log10(Ed_CaDyn_cai(n-1,:))))+152)./(-30.0)))))));
  Ed_CaDyn_cai_k2= -p.Ed_CaDyn_CAF.*((((p.Ed_iHVA_ghva.*Ed_iHVA_u(n-1,:).^2.*Ed_iHVA_w(n-1,:).*(Ed_V(n-1,:)-((min(500,12.5*log(p.Ed_iHVA_cao./Ed_CaDyn_cai(n-1,:))))))))))./(p.Ed_CaDyn_faraday*p.Ed_CaDyn_VshellCa)+(p.Ed_CaDyn_cainf-Ed_CaDyn_cai(n-1,:))./p.Ed_CaDyn_tauCa;
  Ed_KDyn_ko_k2= p.Ed_KDyn_KAF.*((((p.Ed_iDR_gkdr.*Ed_iDR_n(n-1,:).^4.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iDR_ki)))))))+(((( p.Ed_iKS_gks.*Ed_iKS_a(n-1,:).*Ed_iKS_b(n-1,:).*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKS_ki)))))))+((((p.Ed_iKCa_gkc.*Ed_iKCa_c(n-1,:).^2.*(Ed_V(n-1,:)-((25*log(Ed_KDyn_ko(n-1,:)/p.Ed_iKCa_ki))))))))))./(p.Ed_KDyn_faraday*p.Ed_KDyn_VshellK)+(p.Ed_KDyn_koinf-Ed_KDyn_ko(n-1,:))./p.Ed_KDyn_tauK;
  FS_V_k2=(((-((p.FS_iNa_gnaf.*FS_iNa_m(n-1).^3.*FS_iNa_h(n-1).*(FS_V(n-1)-p.FS_iNa_ENa))))+((-((p.FS_iDR_gkdr.*FS_iDR_n(n-1).^4.*(FS_V(n-1)-((25*log(FS_KDyn_ko(n-1)/p.FS_iDR_ki)))))))+((-((p.FS_pas_gpas.*(FS_V(n-1)-p.FS_pas_epas))))+((-(( (p.FS_Es_iAMPA_gAMPA.*(FS_Es_iAMPA_s(n-1,:)*FS_Es_iAMPA_netcon).*(FS_V(n-1)-p.FS_Es_iAMPA_EAMPA)))))+((-(( p.FS_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(FS_V(n-1)./(-16)))))).*(FS_Es_iNMDA_s(n-1,:)*FS_Es_iNMDA_netcon).*(FS_V(n-1)-p.FS_Es_iNMDA_ENMDA))))+((-(( (p.FS_FS_iGABA_gGABA.*(FS_FS_iGABA_s(n-1)*FS_FS_iGABA_netcon).*(FS_V(n-1)-p.FS_FS_iGABA_EGABA)))))))))))+((((-p.FS_gAMPA.*FS_sAMPA(k,:).*(FS_V(n-1)-p.FS_EAMPA)))+((-p.FS_gNMDA.*FS_sNMDA(k,:).*(1.50265./(1+0.33*exp(FS_V(n-1)./(-16)))).*(FS_V(n-1)-p.FS_ENMDA)))+((-p.FS_gGABA.*FS_sGABA(k,:).*(FS_V(n-1)-p.FS_EGABA))))))./p.FS_Cm;
  FS_iNa_m_k2=((((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0))))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0)))/6)))))))-FS_iNa_m(n-1))./((1./((((-.2816*(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0))))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iNa_amV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_amV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_amV0)))/9.3))))+(((.2464*(( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0))))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iNa_bmV0)<p.FS_iNa_eps).*p.FS_iNa_eps+(abs(FS_V(n-1)-p.FS_iNa_bmV0)>=p.FS_iNa_eps).*FS_V(n-1)-p.FS_iNa_bmV0)))/6)))))));
  FS_iNa_h_k2=(((((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))./(((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))+((p.FS_iNa_hnascale.*1.4./(1+exp(-(FS_V(n-1)-p.FS_iNa_bhV0)/10)))))))-FS_iNa_h(n-1))./((1./(((p.FS_iNa_hnascale.*.098./exp((FS_V(n-1)-p.FS_iNa_ahV0)/20)))+((p.FS_iNa_hnascale.*1.4./(1+exp(-(FS_V(n-1)-p.FS_iNa_bhV0)/10)))))));
  FS_iDR_n_k2=(((((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))./(((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))+((.0054*(( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))/12)))))))-FS_iDR_n(n-1))./((1./(((-.018*(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))./(-1+exp(-(( ((abs(FS_V(n-1)-p.FS_iDR_anV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_anV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_anV0)))/25))))+((.0054*(( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))./(-1+exp((( ((abs(FS_V(n-1)-p.FS_iDR_bnV0)<p.FS_iDR_eps).*p.FS_iDR_eps+(abs(FS_V(n-1)-p.FS_iDR_bnV0)>=p.FS_iDR_eps).*FS_V(n-1)-p.FS_iDR_bnV0)))/12)))))));
  FS_KDyn_ko_k2= p.FS_KDyn_KAF.*((((p.FS_iDR_gkdr.*FS_iDR_n(n-1).^4.*(FS_V(n-1)-((25*log(FS_KDyn_ko(n-1)/p.FS_iDR_ki))))))))./(p.FS_KDyn_faraday*p.FS_KDyn_VshellK)+(p.FS_KDyn_koinf-FS_KDyn_ko(n-1))./p.FS_KDyn_tauK;
  Ed_Es_iAMPA_s_k2= -Ed_Es_iAMPA_s(n-1,:)./p.Ed_Es_iAMPA_tauAMPA + ((1-Ed_Es_iAMPA_s(n-1,:))/p.Ed_Es_iAMPA_tauAMPAr).*(1+tanh(Es_V(n-1,:)/10));
  Ed_Es_iNMDA_s_k2= (( p.Ed_Es_iNMDA_Tmax./(1+exp(-(Es_V(n-1,:)-p.Ed_Es_iNMDA_Vpp)/p.Ed_Es_iNMDA_Kp)))).*(1-Ed_Es_iNMDA_s(n-1,:))/p.Ed_Es_iNMDA_tauNMDAr-Ed_Es_iNMDA_s(n-1,:)/p.Ed_Es_iNMDA_tauNMDA;
  FS_Es_iAMPA_s_k2= -FS_Es_iAMPA_s(n-1,:)./p.FS_Es_iAMPA_tauAMPA + ((1-FS_Es_iAMPA_s(n-1,:))/p.FS_Es_iAMPA_tauAMPAr).*(1+tanh(Es_V(n-1,:)/10));
  FS_Es_iNMDA_s_k2= (( p.FS_Es_iNMDA_Tmax./(1+exp(-(Es_V(n-1,:)-p.FS_Es_iNMDA_Vpp)/p.FS_Es_iNMDA_Kp)))).*(1-FS_Es_iNMDA_s(n-1,:))/p.FS_Es_iNMDA_tauNMDAr-FS_Es_iNMDA_s(n-1,:)/p.FS_Es_iNMDA_tauNMDA;
  Es_FS_iGABA_s_k2= -Es_FS_iGABA_s(n-1)./p.Es_FS_iGABA_tauGABA + ((1-Es_FS_iGABA_s(n-1))/p.Es_FS_iGABA_tauGABAr).*(1+tanh(FS_V(n-1)/10));
  FS_FS_iGABA_s_k2= -FS_FS_iGABA_s(n-1)./p.FS_FS_iGABA_tauGABA + ((1-FS_FS_iGABA_s(n-1))/p.FS_FS_iGABA_tauGABAr).*(1+tanh(FS_V(n-1)/10));
  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  Es_V(n,:)=Es_V(n-1,:)+dt*Es_V_k2;
  Es_iNa_m(n,:)=Es_iNa_m(n-1,:)+dt*Es_iNa_m_k2;
  Es_iNa_h(n,:)=Es_iNa_h(n-1,:)+dt*Es_iNa_h_k2;
  Es_iNaP_m(n,:)=Es_iNaP_m(n-1,:)+dt*Es_iNaP_m_k2;
  Es_iNaP_h(n,:)=Es_iNaP_h(n-1,:)+dt*Es_iNaP_h_k2;
  Es_iHVA_u(n,:)=Es_iHVA_u(n-1,:)+dt*Es_iHVA_u_k2;
  Es_iHVA_w(n,:)=Es_iHVA_w(n-1,:)+dt*Es_iHVA_w_k2;
  Es_iDR_n(n,:)=Es_iDR_n(n-1,:)+dt*Es_iDR_n_k2;
  Es_iKS_a(n,:)=Es_iKS_a(n-1,:)+dt*Es_iKS_a_k2;
  Es_iKS_b(n,:)=Es_iKS_b(n-1,:)+dt*Es_iKS_b_k2;
  Es_iKCa_c(n,:)=Es_iKCa_c(n-1,:)+dt*Es_iKCa_c_k2;
  Es_CaDyn_cai(n,:)=Es_CaDyn_cai(n-1,:)+dt*Es_CaDyn_cai_k2;
  Es_KDyn_ko(n,:)=Es_KDyn_ko(n-1,:)+dt*Es_KDyn_ko_k2;
  Ed_V(n,:)=Ed_V(n-1,:)+dt*Ed_V_k2;
  Ed_iNa_m(n,:)=Ed_iNa_m(n-1,:)+dt*Ed_iNa_m_k2;
  Ed_iNa_h(n,:)=Ed_iNa_h(n-1,:)+dt*Ed_iNa_h_k2;
  Ed_iNaP_m(n,:)=Ed_iNaP_m(n-1,:)+dt*Ed_iNaP_m_k2;
  Ed_iNaP_h(n,:)=Ed_iNaP_h(n-1,:)+dt*Ed_iNaP_h_k2;
  Ed_iHVA_u(n,:)=Ed_iHVA_u(n-1,:)+dt*Ed_iHVA_u_k2;
  Ed_iHVA_w(n,:)=Ed_iHVA_w(n-1,:)+dt*Ed_iHVA_w_k2;
  Ed_iDR_n(n,:)=Ed_iDR_n(n-1,:)+dt*Ed_iDR_n_k2;
  Ed_iKS_a(n,:)=Ed_iKS_a(n-1,:)+dt*Ed_iKS_a_k2;
  Ed_iKS_b(n,:)=Ed_iKS_b(n-1,:)+dt*Ed_iKS_b_k2;
  Ed_iKCa_c(n,:)=Ed_iKCa_c(n-1,:)+dt*Ed_iKCa_c_k2;
  Ed_CaDyn_cai(n,:)=Ed_CaDyn_cai(n-1,:)+dt*Ed_CaDyn_cai_k2;
  Ed_KDyn_ko(n,:)=Ed_KDyn_ko(n-1,:)+dt*Ed_KDyn_ko_k2;
  FS_V(n)=FS_V(n-1)+dt*FS_V_k2;
  FS_iNa_m(n)=FS_iNa_m(n-1)+dt*FS_iNa_m_k2;
  FS_iNa_h(n)=FS_iNa_h(n-1)+dt*FS_iNa_h_k2;
  FS_iDR_n(n)=FS_iDR_n(n-1)+dt*FS_iDR_n_k2;
  FS_KDyn_ko(n)=FS_KDyn_ko(n-1)+dt*FS_KDyn_ko_k2;
  Ed_Es_iAMPA_s(n,:)=Ed_Es_iAMPA_s(n-1,:)+dt*Ed_Es_iAMPA_s_k2;
  Ed_Es_iNMDA_s(n,:)=Ed_Es_iNMDA_s(n-1,:)+dt*Ed_Es_iNMDA_s_k2;
  FS_Es_iAMPA_s(n,:)=FS_Es_iAMPA_s(n-1,:)+dt*FS_Es_iAMPA_s_k2;
  FS_Es_iNMDA_s(n,:)=FS_Es_iNMDA_s(n-1,:)+dt*FS_Es_iNMDA_s_k2;
  Es_FS_iGABA_s(n)=Es_FS_iGABA_s(n-1)+dt*Es_FS_iGABA_s_k2;
  FS_FS_iGABA_s(n)=FS_FS_iGABA_s(n-1)+dt*FS_FS_iGABA_s_k2;
  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  Es_input(n,:)=((-p.Es_gAMPA.*Es_sAMPA(k,:).*(Es_V(n,:)-p.Es_EAMPA)))+((-p.Es_gNMDA.*Es_sNMDA(k,:).*(1.50265./(1+0.33*exp(Es_V(n,:)./(-16)))).*(Es_V(n,:)-p.Es_ENMDA)))+((-p.Es_gGABA.*Es_sGABA(k,:).*(Es_V(n,:)-p.Es_EGABA)));
  Ed_input(n,:)=((-p.Ed_gAMPA.*Ed_sAMPA(k,:).*(Ed_V(n,:)-p.Ed_EAMPA)))+((-p.Ed_gNMDA.*Ed_sNMDA(k,:).*(1.50265./(1+0.33*exp(Ed_V(n,:)./(-16)))).*(Ed_V(n,:)-p.Ed_ENMDA)))+((-p.Ed_gGABA.*Ed_sGABA(k,:).*(Ed_V(n,:)-p.Ed_EGABA)));
  FS_input(n,:)=((-p.FS_gAMPA.*FS_sAMPA(k,:).*(FS_V(n,:)-p.FS_EAMPA)))+((-p.FS_gNMDA.*FS_sNMDA(k,:).*(1.50265./(1+0.33*exp(FS_V(n,:)./(-16)))).*(FS_V(n,:)-p.FS_ENMDA)))+((-p.FS_gGABA.*FS_sGABA(k,:).*(FS_V(n,:)-p.FS_EGABA)));
  Ed_Es_iAMPA_IAMPA(n,:)=(p.Ed_Es_iAMPA_gAMPA.*(Ed_Es_iAMPA_s(n,:)*Ed_Es_iAMPA_netcon).*(Ed_V(n,:)-p.Ed_Es_iAMPA_EAMPA));
  Ed_Es_iNMDA_BMg(n,:)=(1.50265./(1+0.33*exp(Ed_V(n,:)./(-16))));
  Ed_Es_iNMDA_INMDA(n,:)=p.Ed_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(Ed_V(n,:)./(-16)))))).*(Ed_Es_iNMDA_s(n,:)*Ed_Es_iNMDA_netcon).*(Ed_V(n,:)-p.Ed_Es_iNMDA_ENMDA);
  Ed_Es_iNMDA_NT(n,:)=p.Ed_Es_iNMDA_Tmax./(1+exp(-(Ed_V(n,:)-p.Ed_Es_iNMDA_Vpp)/p.Ed_Es_iNMDA_Kp));
  Es_FS_iGABA_IGABA(n,:)=(p.Es_FS_iGABA_gGABA.*(Es_FS_iGABA_s(n,:)*Es_FS_iGABA_netcon).*(Es_V(n,:)-p.Es_FS_iGABA_EGABA));
  FS_Es_iAMPA_IAMPA(n,:)=(p.FS_Es_iAMPA_gAMPA.*(FS_Es_iAMPA_s(n,:)*FS_Es_iAMPA_netcon).*(FS_V(n,:)-p.FS_Es_iAMPA_EAMPA));
  FS_Es_iNMDA_BMg(n,:)=(1.50265./(1+0.33*exp(FS_V(n,:)./(-16))));
  FS_Es_iNMDA_INMDA(n,:)=p.FS_Es_iNMDA_gNMDA.*(( (1.50265./(1+0.33*exp(FS_V(n,:)./(-16)))))).*(FS_Es_iNMDA_s(n,:)*FS_Es_iNMDA_netcon).*(FS_V(n,:)-p.FS_Es_iNMDA_ENMDA);
  FS_Es_iNMDA_NT(n,:)=p.FS_Es_iNMDA_Tmax./(1+exp(-(FS_V(n,:)-p.FS_Es_iNMDA_Vpp)/p.FS_Es_iNMDA_Kp));
  FS_FS_iGABA_IGABA(n,:)=(p.FS_FS_iGABA_gGABA.*(FS_FS_iGABA_s(n,:)*FS_FS_iGABA_netcon).*(FS_V(n,:)-p.FS_FS_iGABA_EGABA));
  n=n+1;
end
T=T(1:downsample_factor:ntime);
