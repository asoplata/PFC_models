function [T,Es_V,Es_DS00iNa_m,Es_DS00iNa_h,Es_DS00iNaP_m,Es_DS00iNaP_h,Es_DS00iDR_n,Es_DS02iKS_a,Es_DS02iKS_b,Es_DS02iHVA_u,Es_DS02iHVA_w,Es_DS00iKCa_c,Es_DS00CaDyn_cai,Es_DS00KDyn_ko,Es_TW03iH_m,Ed_V,Ed_DS00iNa_m,Ed_DS00iNa_h,Ed_DS00iNaP_m,Ed_DS00iNaP_h,Ed_DS00iDR_n,Ed_DS02iKS_a,Ed_DS02iKS_b,Ed_DS02iHVA_u,Ed_DS02iHVA_w,Ed_DS00iKCa_c,Ed_DS00CaDyn_cai,Ed_DS00KDyn_ko,Ed_TW03iH_m,Es_DS02iHVA_wtauHVA,Ed_DS02iHVA_wtauHVA]=solve_ode
% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
p=load('params.mat','p'); p=p.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);
% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
Es_DS02iHVA_wtauHVA = 420/3;
Ed_DS02iHVA_wtauHVA = 420/3;
% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
% seed the random number generator
rng(p.random_seed);
t=0; k=1;
% STATE_VARIABLES:
Es_V = zeros(nsamp,p.Es_Npop);
  Es_V(1,:) = -65*ones(1,p.Es_Npop);
Es_DS00iNa_m = zeros(nsamp,p.Es_Npop);
  Es_DS00iNa_m(1,:) = (((((-.2816*(( ((abs(-65-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(-65-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(-65-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_bmV0))))./(-1+exp((( ((abs(-65-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(-65-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*-65-p.Es_DS00iNa_bmV0)))/6)))))))+p.Es_DS00iNa_IC_noise.*rand(1,p.Es_Npop);
Es_DS00iNa_h = zeros(nsamp,p.Es_Npop);
  Es_DS00iNa_h(1,:) = ((((p.Es_DS00iNa_hnascale.*.098./exp((-65-p.Es_DS00iNa_ahV0)/20)))./(((p.Es_DS00iNa_hnascale.*.098./exp((-65-p.Es_DS00iNa_ahV0)/20)))+((p.Es_DS00iNa_hnascale.*1.4./(1+exp(-(-65-p.Es_DS00iNa_bhV0)/10)))))))+p.Es_DS00iNa_IC_noise.*rand(1,p.Es_Npop);
Es_DS00iNaP_m = zeros(nsamp,p.Es_Npop);
  Es_DS00iNaP_m(1,:) = (((((-.2816*(( ((abs(-65+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65+12)>=p.Es_DS00iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65+12)>=p.Es_DS00iNaP_eps).*-65+12)))/9.3))))./((((-.2816*(( ((abs(-65+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65+12)>=p.Es_DS00iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65+12)>=p.Es_DS00iNaP_eps).*-65+12)))/9.3))))+(((.2464*(( ((abs(-65-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65-15)>=p.Es_DS00iNaP_eps).*-65-15))))./(-1+exp((( ((abs(-65-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(-65-15)>=p.Es_DS00iNaP_eps).*-65-15)))/6)))))))+p.Es_DS00iNaP_IC_noise.*rand(1,p.Es_Npop);
Es_DS00iNaP_h = zeros(nsamp,p.Es_Npop);
  Es_DS00iNaP_h(1,:) = ((((2.8e-5./exp((-65+42.8477)/4.0248)))./(((2.8e-5./exp((-65+42.8477)/4.0248)))+((.02./(1+exp(-(-65-413.9284)/148.2589)))))))+p.Es_DS00iNaP_IC_noise.*rand(1,p.Es_Npop);
Es_DS00iDR_n = zeros(nsamp,p.Es_Npop);
  Es_DS00iDR_n(1,:) = ((((-.018*(( ((abs(-65-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_anV0)))/25))))./(((-.018*(( ((abs(-65-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(-65-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_bnV0)))./(-1+exp((( ((abs(-65-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(-65-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*-65-p.Es_DS00iDR_bnV0)))/12)))))))+p.Es_DS00iDR_IC_noise.*rand(1,p.Es_Npop);
Es_DS02iKS_a = zeros(nsamp,p.Es_Npop);
  Es_DS02iKS_a(1,:) = ((1./(1+exp(-(-65+34)/6.5))))+p.Es_DS02iKS_IC_noise.*rand(1,p.Es_Npop);
Es_DS02iKS_b = zeros(nsamp,p.Es_Npop);
  Es_DS02iKS_b(1,:) = ((1./(1+exp((-65+65)/6.6))))+p.Es_DS02iKS_IC_noise.*rand(1,p.Es_Npop);
Es_DS02iHVA_u = zeros(nsamp,p.Es_Npop);
  Es_DS02iHVA_u(1,:) = ((1./(1+exp(-(-65+24.6)/11.3))))+p.Es_DS02iHVA_IC_noise.*rand(1,p.Es_Npop);
Es_DS02iHVA_w = zeros(nsamp,p.Es_Npop);
  Es_DS02iHVA_w(1,:) = ((1./(1+exp((-65+12.6)/18.9))))+p.Es_DS02iHVA_IC_noise.*rand(1,p.Es_Npop);
Es_DS00iKCa_c = zeros(nsamp,p.Es_Npop);
  Es_DS00iKCa_c(1,:) = (((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_DS00iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_DS00iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))./((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_DS00iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Es_DS00iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))+((1.7*exp((((-65+40*log10(.05)))+152)./(-30.0)))))))+p.Es_DS00iKCa_IC_noise.*rand(1,p.Es_Npop);
Es_DS00CaDyn_cai = zeros(nsamp,p.Es_Npop);
  Es_DS00CaDyn_cai(1,:) =  p.Es_DS00CaDyn_cainf+p.Es_DS00CaDyn_IC_noise.*rand(1,p.Es_Npop);
Es_DS00KDyn_ko = zeros(nsamp,p.Es_Npop);
  Es_DS00KDyn_ko(1,:) =  p.Es_DS00KDyn_koinf+p.Es_DS00KDyn_IC_noise.*rand(1,p.Es_Npop);
Es_TW03iH_m = zeros(nsamp,p.Es_Npop);
  Es_TW03iH_m(1,:) =  p.Es_TW03iH_IC+p.Es_TW03iH_IC_noise.*rand(1,p.Es_Npop);
Ed_V = zeros(nsamp,p.Ed_Npop);
  Ed_V(1,:) = -65*ones(1,p.Ed_Npop);
Ed_DS00iNa_m = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iNa_m(1,:) = (((((-.2816*(( ((abs(-65-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(-65-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_amV0))))./(-1+exp(-(( ((abs(-65-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(-65-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_bmV0))))./(-1+exp((( ((abs(-65-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(-65-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*-65-p.Ed_DS00iNa_bmV0)))/6)))))))+p.Ed_DS00iNa_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00iNa_h = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iNa_h(1,:) = ((((p.Ed_DS00iNa_hnascale.*.098./exp((-65-p.Ed_DS00iNa_ahV0)/20)))./(((p.Ed_DS00iNa_hnascale.*.098./exp((-65-p.Ed_DS00iNa_ahV0)/20)))+((p.Ed_DS00iNa_hnascale.*1.4./(1+exp(-(-65-p.Ed_DS00iNa_bhV0)/10)))))))+p.Ed_DS00iNa_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00iNaP_m = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iNaP_m(1,:) = (((((-.2816*(( ((abs(-65+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65+12)>=p.Ed_DS00iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65+12)>=p.Ed_DS00iNaP_eps).*-65+12)))/9.3))))./((((-.2816*(( ((abs(-65+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65+12)>=p.Ed_DS00iNaP_eps).*-65+12))))./(-1+exp(-(( ((abs(-65+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65+12)>=p.Ed_DS00iNaP_eps).*-65+12)))/9.3))))+(((.2464*(( ((abs(-65-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65-15)>=p.Ed_DS00iNaP_eps).*-65-15))))./(-1+exp((( ((abs(-65-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(-65-15)>=p.Ed_DS00iNaP_eps).*-65-15)))/6)))))))+p.Ed_DS00iNaP_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00iNaP_h = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iNaP_h(1,:) = ((((2.8e-5./exp((-65+42.8477)/4.0248)))./(((2.8e-5./exp((-65+42.8477)/4.0248)))+((.02./(1+exp(-(-65-413.9284)/148.2589)))))))+p.Ed_DS00iNaP_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00iDR_n = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iDR_n(1,:) = ((((-.018*(( ((abs(-65-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_anV0)))/25))))./(((-.018*(( ((abs(-65-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_anV0)))./(-1+exp(-(( ((abs(-65-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(-65-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_bnV0)))./(-1+exp((( ((abs(-65-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(-65-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*-65-p.Ed_DS00iDR_bnV0)))/12)))))))+p.Ed_DS00iDR_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS02iKS_a = zeros(nsamp,p.Ed_Npop);
  Ed_DS02iKS_a(1,:) = ((1./(1+exp(-(-65+34)/6.5))))+p.Ed_DS02iKS_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS02iKS_b = zeros(nsamp,p.Ed_Npop);
  Ed_DS02iKS_b(1,:) = ((1./(1+exp((-65+65)/6.6))))+p.Ed_DS02iKS_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS02iHVA_u = zeros(nsamp,p.Ed_Npop);
  Ed_DS02iHVA_u(1,:) = ((1./(1+exp(-(-65+24.6)/11.3))))+p.Ed_DS02iHVA_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS02iHVA_w = zeros(nsamp,p.Ed_Npop);
  Ed_DS02iHVA_w(1,:) = ((1./(1+exp((-65+12.6)/18.9))))+p.Ed_DS02iHVA_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00iKCa_c = zeros(nsamp,p.Ed_Npop);
  Ed_DS00iKCa_c(1,:) = (((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_DS00iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_DS00iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))./((((-0.00642*(( ((abs(((-65+40*log10(.05)))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_DS00iKCa_eps).*((-65+40*log10(.05)))+18))))./(-1+exp((( ((abs(((-65+40*log10(.05)))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((-65+40*log10(.05)))+18)>=p.Ed_DS00iKCa_eps).*((-65+40*log10(.05)))+18)))./(-12)))))+((1.7*exp((((-65+40*log10(.05)))+152)./(-30.0)))))))+p.Ed_DS00iKCa_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00CaDyn_cai = zeros(nsamp,p.Ed_Npop);
  Ed_DS00CaDyn_cai(1,:) =  p.Ed_DS00CaDyn_cainf+p.Ed_DS00CaDyn_IC_noise.*rand(1,p.Ed_Npop);
Ed_DS00KDyn_ko = zeros(nsamp,p.Ed_Npop);
  Ed_DS00KDyn_ko(1,:) =  p.Ed_DS00KDyn_koinf+p.Ed_DS00KDyn_IC_noise.*rand(1,p.Ed_Npop);
Ed_TW03iH_m = zeros(nsamp,p.Ed_Npop);
  Ed_TW03iH_m(1,:) =  p.Ed_TW03iH_IC+p.Ed_TW03iH_IC_noise.*rand(1,p.Ed_Npop);
% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  Es_V_k1=(((-((p.Es_DS00iNa_gnaf.*Es_DS00iNa_m(n-1).^3.*Es_DS00iNa_h(n-1).*(Es_V(n-1)-p.Es_DS00iNa_ENa))))+((-((p.Es_DS00iNaP_gnap.*Es_DS00iNaP_m(n-1).*Es_DS00iNaP_h(n-1).*(Es_V(n-1)-p.Es_DS00iNaP_ENa))))+((-((p.Es_DS00iDR_gkdr.*Es_DS00iDR_n(n-1).^4.*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS00iDR_ki)))))))+((-(( p.Es_DS02iKS_gks.*Es_DS02iKS_a(n-1).*Es_DS02iKS_b(n-1).*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS02iKS_ki)))))))+((-((p.Es_DS02iHVA_ghva.*Es_DS02iHVA_u(n-1).^2.*Es_DS02iHVA_w(n-1).*(Es_V(n-1)-((min(500,12.5*log(p.Es_DS02iHVA_cao./Es_DS00CaDyn_cai(n-1)))))))))+((-((p.Es_DS00iKCa_gkc.*Es_DS00iKCa_c(n-1).^2.*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS00iKCa_ki)))))))+((-(( p.Es_TW03iH_gH.*Es_TW03iH_m(n-1).*(Es_V(n-1)-p.Es_TW03iH_E_AR))))+((-((p.Es_pas_gpas.*(Es_V(n-1)-p.Es_pas_epas))))+(((( p.Es_Ed_iCOM_gCOM.*(Ed_V(n-1)-Es_V(n-1))))))))))))))+p.Es_Iapp)./p.Es_Cm;
  Es_DS00iNa_m_k1=((((((-.2816*(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_bmV0)))/6)))))))-Es_DS00iNa_m(n-1))./((1./((((-.2816*(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iNa_amV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_amV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_bmV0))))./(-1+exp((( ((abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)<p.Es_DS00iNa_eps).*p.Es_DS00iNa_eps+(abs(Es_V(n-1)-p.Es_DS00iNa_bmV0)>=p.Es_DS00iNa_eps).*Es_V(n-1)-p.Es_DS00iNa_bmV0)))/6)))))));
  Es_DS00iNa_h_k1=(((((p.Es_DS00iNa_hnascale.*.098./exp((Es_V(n-1)-p.Es_DS00iNa_ahV0)/20)))./(((p.Es_DS00iNa_hnascale.*.098./exp((Es_V(n-1)-p.Es_DS00iNa_ahV0)/20)))+((p.Es_DS00iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1)-p.Es_DS00iNa_bhV0)/10)))))))-Es_DS00iNa_h(n-1))./((1./(((p.Es_DS00iNa_hnascale.*.098./exp((Es_V(n-1)-p.Es_DS00iNa_ahV0)/20)))+((p.Es_DS00iNa_hnascale.*1.4./(1+exp(-(Es_V(n-1)-p.Es_DS00iNa_bhV0)/10)))))));
  Es_DS00iNaP_m_k1=((((((-.2816*(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12))))./(-1+exp(-(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12)))/9.3))))./((((-.2816*(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12))))./(-1+exp(-(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1)-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)-15)>=p.Es_DS00iNaP_eps).*Es_V(n-1)-15))))./(-1+exp((( ((abs(Es_V(n-1)-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)-15)>=p.Es_DS00iNaP_eps).*Es_V(n-1)-15)))/6)))))))-Es_DS00iNaP_m(n-1))./((1./((((-.2816*(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12))))./(-1+exp(-(( ((abs(Es_V(n-1)+12)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)+12)>=p.Es_DS00iNaP_eps).*Es_V(n-1)+12)))/9.3))))+(((.2464*(( ((abs(Es_V(n-1)-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)-15)>=p.Es_DS00iNaP_eps).*Es_V(n-1)-15))))./(-1+exp((( ((abs(Es_V(n-1)-15)<p.Es_DS00iNaP_eps).*p.Es_DS00iNaP_eps+(abs(Es_V(n-1)-15)>=p.Es_DS00iNaP_eps).*Es_V(n-1)-15)))/6)))))));
  Es_DS00iNaP_h_k1=(((((2.8e-5./exp((Es_V(n-1)+42.8477)/4.0248)))./(((2.8e-5./exp((Es_V(n-1)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1)-413.9284)/148.2589)))))))-Es_DS00iNaP_h(n-1))./((p.Es_DS00iNaP_htaunap*1./(((2.8e-5./exp((Es_V(n-1)+42.8477)/4.0248)))+((.02./(1+exp(-(Es_V(n-1)-413.9284)/148.2589)))))));
  Es_DS00iDR_n_k1=(((((-.018*(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))/25))))./(((-.018*(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_bnV0)))/12)))))))-Es_DS00iDR_n(n-1))./((1./(((-.018*(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Es_V(n-1)-p.Es_DS00iDR_anV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_anV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_bnV0)))./(-1+exp((( ((abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)<p.Es_DS00iDR_eps).*p.Es_DS00iDR_eps+(abs(Es_V(n-1)-p.Es_DS00iDR_bnV0)>=p.Es_DS00iDR_eps).*Es_V(n-1)-p.Es_DS00iDR_bnV0)))/12)))))));
  Es_DS02iKS_a_k1=(((1./(1+exp(-(Es_V(n-1)+34)/6.5))))-Es_DS02iKS_a(n-1))./((6));
  Es_DS02iKS_b_k1=(((1./(1+exp((Es_V(n-1)+65)/6.6))))-Es_DS02iKS_b(n-1))./((200+220./(1+exp(-(Es_V(n-1)+71.6)/6.85))));
  Es_DS02iHVA_u_k1=(((1./(1+exp(-(Es_V(n-1)+24.6)/11.3))))-Es_DS02iHVA_u(n-1))./((1.25*sech(-.031*(Es_V(n-1)+37.1))));
  Es_DS02iHVA_w_k1=(((1./(1+exp((Es_V(n-1)+12.6)/18.9))))-Es_DS02iHVA_w(n-1))./((Es_DS02iHVA_wtauHVA));
  Es_DS00iKCa_c_k1=((((((-0.00642*(( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+152)./(-30.0)))))))-Es_DS00iKCa_c(n-1))./((1./((((-0.00642*(( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)<p.Es_DS00iKCa_eps).*p.Es_DS00iKCa_eps+(abs(((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)>=p.Es_DS00iKCa_eps).*((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+18)))./(-12)))))+((1.7*exp((((Es_V(n-1)+40*log10(Es_DS00CaDyn_cai(n-1))))+152)./(-30.0)))))));
  Es_DS00CaDyn_cai_k1= -p.Es_DS00CaDyn_CAF.*((((p.Es_DS02iHVA_ghva.*Es_DS02iHVA_u(n-1).^2.*Es_DS02iHVA_w(n-1).*(Es_V(n-1)-((min(500,12.5*log(p.Es_DS02iHVA_cao./Es_DS00CaDyn_cai(n-1))))))))))./(p.Es_DS00CaDyn_faraday*p.Es_DS00CaDyn_VshellCa)+(p.Es_DS00CaDyn_cainf-Es_DS00CaDyn_cai(n-1))./p.Es_DS00CaDyn_tauCa;
  Es_DS00KDyn_ko_k1= p.Es_DS00KDyn_KAF.*((((p.Es_DS00iDR_gkdr.*Es_DS00iDR_n(n-1).^4.*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS00iDR_ki)))))))+(((( p.Es_DS02iKS_gks.*Es_DS02iKS_a(n-1).*Es_DS02iKS_b(n-1).*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS02iKS_ki)))))))+((((p.Es_DS00iKCa_gkc.*Es_DS00iKCa_c(n-1).^2.*(Es_V(n-1)-((25*log(Es_DS00KDyn_ko(n-1)/p.Es_DS00iKCa_ki))))))))))./(p.Es_DS00KDyn_faraday*p.Es_DS00KDyn_VshellK)+(p.Es_DS00KDyn_koinf-Es_DS00KDyn_ko(n-1))./p.Es_DS00KDyn_tauK;
  Es_TW03iH_m_k1= (( p.Es_TW03iH_c_ARaM.*((( 1 ./ (1+exp((p.Es_TW03iH_AR_V12-Es_V(n-1))/p.Es_TW03iH_AR_k)))) ./ (( 1./(p.Es_TW03iH_AR_L.*exp(-14.6-.086*Es_V(n-1))+p.Es_TW03iH_AR_R.*exp(-1.87+.07*Es_V(n-1)))))))).*(1-Es_TW03iH_m(n-1))-(( p.Es_TW03iH_c_ARbM.*((1-(( 1 ./ (1+exp((p.Es_TW03iH_AR_V12-Es_V(n-1))/p.Es_TW03iH_AR_k)))))./(( 1./(p.Es_TW03iH_AR_L.*exp(-14.6-.086*Es_V(n-1))+p.Es_TW03iH_AR_R.*exp(-1.87+.07*Es_V(n-1)))))))).*Es_TW03iH_m(n-1);
  Ed_V_k1=(((-((p.Ed_DS00iNa_gnaf.*Ed_DS00iNa_m(n-1).^3.*Ed_DS00iNa_h(n-1).*(Ed_V(n-1)-p.Ed_DS00iNa_ENa))))+((-((p.Ed_DS00iNaP_gnap.*Ed_DS00iNaP_m(n-1).*Ed_DS00iNaP_h(n-1).*(Ed_V(n-1)-p.Ed_DS00iNaP_ENa))))+((-((p.Ed_DS00iDR_gkdr.*Ed_DS00iDR_n(n-1).^4.*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS00iDR_ki)))))))+((-(( p.Ed_DS02iKS_gks.*Ed_DS02iKS_a(n-1).*Ed_DS02iKS_b(n-1).*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS02iKS_ki)))))))+((-((p.Ed_DS02iHVA_ghva.*Ed_DS02iHVA_u(n-1).^2.*Ed_DS02iHVA_w(n-1).*(Ed_V(n-1)-((min(500,12.5*log(p.Ed_DS02iHVA_cao./Ed_DS00CaDyn_cai(n-1)))))))))+((-((p.Ed_DS00iKCa_gkc.*Ed_DS00iKCa_c(n-1).^2.*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS00iKCa_ki)))))))+((-(( p.Ed_TW03iH_gH.*Ed_TW03iH_m(n-1).*(Ed_V(n-1)-p.Ed_TW03iH_E_AR))))+((-((p.Ed_pas_gpas.*(Ed_V(n-1)-p.Ed_pas_epas))))+(((( p.Ed_Es_iCOM_gCOM.*(Es_V(n-1)-Ed_V(n-1))))))))))))))+p.Ed_Iapp)./p.Ed_Cm;
  Ed_DS00iNa_m_k1=((((((-.2816*(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_bmV0)))/6)))))))-Ed_DS00iNa_m(n-1))./((1./((((-.2816*(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0))))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_amV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_amV0)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_bmV0))))./(-1+exp((( ((abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)<p.Ed_DS00iNa_eps).*p.Ed_DS00iNa_eps+(abs(Ed_V(n-1)-p.Ed_DS00iNa_bmV0)>=p.Ed_DS00iNa_eps).*Ed_V(n-1)-p.Ed_DS00iNa_bmV0)))/6)))))));
  Ed_DS00iNa_h_k1=(((((p.Ed_DS00iNa_hnascale.*.098./exp((Ed_V(n-1)-p.Ed_DS00iNa_ahV0)/20)))./(((p.Ed_DS00iNa_hnascale.*.098./exp((Ed_V(n-1)-p.Ed_DS00iNa_ahV0)/20)))+((p.Ed_DS00iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1)-p.Ed_DS00iNa_bhV0)/10)))))))-Ed_DS00iNa_h(n-1))./((1./(((p.Ed_DS00iNa_hnascale.*.098./exp((Ed_V(n-1)-p.Ed_DS00iNa_ahV0)/20)))+((p.Ed_DS00iNa_hnascale.*1.4./(1+exp(-(Ed_V(n-1)-p.Ed_DS00iNa_bhV0)/10)))))));
  Ed_DS00iNaP_m_k1=((((((-.2816*(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12)))/9.3))))./((((-.2816*(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1)-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)-15)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)-15))))./(-1+exp((( ((abs(Ed_V(n-1)-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)-15)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)-15)))/6)))))))-Ed_DS00iNaP_m(n-1))./((1./((((-.2816*(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12))))./(-1+exp(-(( ((abs(Ed_V(n-1)+12)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)+12)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)+12)))/9.3))))+(((.2464*(( ((abs(Ed_V(n-1)-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)-15)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)-15))))./(-1+exp((( ((abs(Ed_V(n-1)-15)<p.Ed_DS00iNaP_eps).*p.Ed_DS00iNaP_eps+(abs(Ed_V(n-1)-15)>=p.Ed_DS00iNaP_eps).*Ed_V(n-1)-15)))/6)))))));
  Ed_DS00iNaP_h_k1=(((((2.8e-5./exp((Ed_V(n-1)+42.8477)/4.0248)))./(((2.8e-5./exp((Ed_V(n-1)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1)-413.9284)/148.2589)))))))-Ed_DS00iNaP_h(n-1))./((p.Ed_DS00iNaP_htaunap*1./(((2.8e-5./exp((Ed_V(n-1)+42.8477)/4.0248)))+((.02./(1+exp(-(Ed_V(n-1)-413.9284)/148.2589)))))));
  Ed_DS00iDR_n_k1=(((((-.018*(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))/25))))./(((-.018*(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_bnV0)))/12)))))))-Ed_DS00iDR_n(n-1))./((1./(((-.018*(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))./(-1+exp(-(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_anV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_anV0)))/25))))+((.0054*(( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_bnV0)))./(-1+exp((( ((abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)<p.Ed_DS00iDR_eps).*p.Ed_DS00iDR_eps+(abs(Ed_V(n-1)-p.Ed_DS00iDR_bnV0)>=p.Ed_DS00iDR_eps).*Ed_V(n-1)-p.Ed_DS00iDR_bnV0)))/12)))))));
  Ed_DS02iKS_a_k1=(((1./(1+exp(-(Ed_V(n-1)+34)/6.5))))-Ed_DS02iKS_a(n-1))./((6));
  Ed_DS02iKS_b_k1=(((1./(1+exp((Ed_V(n-1)+65)/6.6))))-Ed_DS02iKS_b(n-1))./((200+220./(1+exp(-(Ed_V(n-1)+71.6)/6.85))));
  Ed_DS02iHVA_u_k1=(((1./(1+exp(-(Ed_V(n-1)+24.6)/11.3))))-Ed_DS02iHVA_u(n-1))./((1.25*sech(-.031*(Ed_V(n-1)+37.1))));
  Ed_DS02iHVA_w_k1=(((1./(1+exp((Ed_V(n-1)+12.6)/18.9))))-Ed_DS02iHVA_w(n-1))./((Ed_DS02iHVA_wtauHVA));
  Ed_DS00iKCa_c_k1=((((((-0.00642*(( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)))./(-12)))))./((((-0.00642*(( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+152)./(-30.0)))))))-Ed_DS00iKCa_c(n-1))./((1./((((-0.00642*(( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18))))./(-1+exp((( ((abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)<p.Ed_DS00iKCa_eps).*p.Ed_DS00iKCa_eps+(abs(((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)>=p.Ed_DS00iKCa_eps).*((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+18)))./(-12)))))+((1.7*exp((((Ed_V(n-1)+40*log10(Ed_DS00CaDyn_cai(n-1))))+152)./(-30.0)))))));
  Ed_DS00CaDyn_cai_k1= -p.Ed_DS00CaDyn_CAF.*((((p.Ed_DS02iHVA_ghva.*Ed_DS02iHVA_u(n-1).^2.*Ed_DS02iHVA_w(n-1).*(Ed_V(n-1)-((min(500,12.5*log(p.Ed_DS02iHVA_cao./Ed_DS00CaDyn_cai(n-1))))))))))./(p.Ed_DS00CaDyn_faraday*p.Ed_DS00CaDyn_VshellCa)+(p.Ed_DS00CaDyn_cainf-Ed_DS00CaDyn_cai(n-1))./p.Ed_DS00CaDyn_tauCa;
  Ed_DS00KDyn_ko_k1= p.Ed_DS00KDyn_KAF.*((((p.Ed_DS00iDR_gkdr.*Ed_DS00iDR_n(n-1).^4.*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS00iDR_ki)))))))+(((( p.Ed_DS02iKS_gks.*Ed_DS02iKS_a(n-1).*Ed_DS02iKS_b(n-1).*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS02iKS_ki)))))))+((((p.Ed_DS00iKCa_gkc.*Ed_DS00iKCa_c(n-1).^2.*(Ed_V(n-1)-((25*log(Ed_DS00KDyn_ko(n-1)/p.Ed_DS00iKCa_ki))))))))))./(p.Ed_DS00KDyn_faraday*p.Ed_DS00KDyn_VshellK)+(p.Ed_DS00KDyn_koinf-Ed_DS00KDyn_ko(n-1))./p.Ed_DS00KDyn_tauK;
  Ed_TW03iH_m_k1= (( p.Ed_TW03iH_c_ARaM.*((( 1 ./ (1+exp((p.Ed_TW03iH_AR_V12-Ed_V(n-1))/p.Ed_TW03iH_AR_k)))) ./ (( 1./(p.Ed_TW03iH_AR_L.*exp(-14.6-.086*Ed_V(n-1))+p.Ed_TW03iH_AR_R.*exp(-1.87+.07*Ed_V(n-1)))))))).*(1-Ed_TW03iH_m(n-1))-(( p.Ed_TW03iH_c_ARbM.*((1-(( 1 ./ (1+exp((p.Ed_TW03iH_AR_V12-Ed_V(n-1))/p.Ed_TW03iH_AR_k)))))./(( 1./(p.Ed_TW03iH_AR_L.*exp(-14.6-.086*Ed_V(n-1))+p.Ed_TW03iH_AR_R.*exp(-1.87+.07*Ed_V(n-1)))))))).*Ed_TW03iH_m(n-1);
  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  Es_V(n)=Es_V(n-1)+dt*Es_V_k1;
  Es_DS00iNa_m(n)=Es_DS00iNa_m(n-1)+dt*Es_DS00iNa_m_k1;
  Es_DS00iNa_h(n)=Es_DS00iNa_h(n-1)+dt*Es_DS00iNa_h_k1;
  Es_DS00iNaP_m(n)=Es_DS00iNaP_m(n-1)+dt*Es_DS00iNaP_m_k1;
  Es_DS00iNaP_h(n)=Es_DS00iNaP_h(n-1)+dt*Es_DS00iNaP_h_k1;
  Es_DS00iDR_n(n)=Es_DS00iDR_n(n-1)+dt*Es_DS00iDR_n_k1;
  Es_DS02iKS_a(n)=Es_DS02iKS_a(n-1)+dt*Es_DS02iKS_a_k1;
  Es_DS02iKS_b(n)=Es_DS02iKS_b(n-1)+dt*Es_DS02iKS_b_k1;
  Es_DS02iHVA_u(n)=Es_DS02iHVA_u(n-1)+dt*Es_DS02iHVA_u_k1;
  Es_DS02iHVA_w(n)=Es_DS02iHVA_w(n-1)+dt*Es_DS02iHVA_w_k1;
  Es_DS00iKCa_c(n)=Es_DS00iKCa_c(n-1)+dt*Es_DS00iKCa_c_k1;
  Es_DS00CaDyn_cai(n)=Es_DS00CaDyn_cai(n-1)+dt*Es_DS00CaDyn_cai_k1;
  Es_DS00KDyn_ko(n)=Es_DS00KDyn_ko(n-1)+dt*Es_DS00KDyn_ko_k1;
  Es_TW03iH_m(n)=Es_TW03iH_m(n-1)+dt*Es_TW03iH_m_k1;
  Ed_V(n)=Ed_V(n-1)+dt*Ed_V_k1;
  Ed_DS00iNa_m(n)=Ed_DS00iNa_m(n-1)+dt*Ed_DS00iNa_m_k1;
  Ed_DS00iNa_h(n)=Ed_DS00iNa_h(n-1)+dt*Ed_DS00iNa_h_k1;
  Ed_DS00iNaP_m(n)=Ed_DS00iNaP_m(n-1)+dt*Ed_DS00iNaP_m_k1;
  Ed_DS00iNaP_h(n)=Ed_DS00iNaP_h(n-1)+dt*Ed_DS00iNaP_h_k1;
  Ed_DS00iDR_n(n)=Ed_DS00iDR_n(n-1)+dt*Ed_DS00iDR_n_k1;
  Ed_DS02iKS_a(n)=Ed_DS02iKS_a(n-1)+dt*Ed_DS02iKS_a_k1;
  Ed_DS02iKS_b(n)=Ed_DS02iKS_b(n-1)+dt*Ed_DS02iKS_b_k1;
  Ed_DS02iHVA_u(n)=Ed_DS02iHVA_u(n-1)+dt*Ed_DS02iHVA_u_k1;
  Ed_DS02iHVA_w(n)=Ed_DS02iHVA_w(n-1)+dt*Ed_DS02iHVA_w_k1;
  Ed_DS00iKCa_c(n)=Ed_DS00iKCa_c(n-1)+dt*Ed_DS00iKCa_c_k1;
  Ed_DS00CaDyn_cai(n)=Ed_DS00CaDyn_cai(n-1)+dt*Ed_DS00CaDyn_cai_k1;
  Ed_DS00KDyn_ko(n)=Ed_DS00KDyn_ko(n-1)+dt*Ed_DS00KDyn_ko_k1;
  Ed_TW03iH_m(n)=Ed_TW03iH_m(n-1)+dt*Ed_TW03iH_m_k1;
  n=n+1;
end
T=T(1:downsample_factor:ntime);
